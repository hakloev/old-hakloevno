<!DOCTYPE html>
<html>
    <head>
        <title>Config for atpebble</title>
        <meta charset="utf-8">
        <meta name="author" content="Håkon Ødegård Løvdal">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.css" />
        <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.js"></script>
        <script type="text/javascript">
                var url = "/busstops/";
                $.ajax({
                    url: url,
                    dataType: 'json',
                    success: function (data) {
                        for (var i = 0; i < data.length; i++) {
                            $("#stops").append('<li class="ui-screen-hidden"><a onclick="setBus(this);" data-custom-value="' + data[i].locationId + '">' + data[i].name + '</a></li>')
                        }
                    }.bind(this),
                    error: function (xhr, status, err) {
                        console.log(url, status, err.toString());
                    }.bind(this)
                });
        </script>
    </head>
    <body>  
        <div data-role="page" id="main">
            <div data-role="header" class="jqm-header">
                <h1>Settings:</h1>
            </div>
            
            <div data-role="content">
                <div data-role="fieldcontain">
                    <label for="stopId1">First stop:</label>
                    <input type="text" name="stopId1" id="stopId1" />
                </div>
                <div data-role="fieldcontain">
                    <label for="stopId2">Second stop:</label>
                    <input type="text" name="stopId2" id="stopId2" />
                </div>
                <div data-role="fieldcontain" id="infodiv">
                </div>
                <div data-role="fieldcontain">
                    <label for="ui-filterable">Search:</label>
                    <form class="ui-filterable">
                        <input id="inset-autocomplete-input" data-type="search" placeholder="Search stops...">
                    </form>                
                    <ul id="stops" data-role="listview" data-inset="true" data-filter="true" data-filter-reveal="true" data-input="#inset-autocomplete-input"></ul>
                </div>
                <div data-role="fieldcontain">
                    <label for="route">Prefered route:</label>
                    <input type="number" name="route" id="route" />
                </div>        
            </div> 
            <div class="ui-body ui-body-b">
                <fieldset class="ui-grid-a">
                    <div class="ui-block-a"><button type="submit" data-theme-"d" id="b-cancel">Cancel</button></div>
                    <div class="ui-block-b"><button type="submit" data-theme-"a" id="b-submit">Submit</button></div>
                </fieldset>
            </div>
        </div>
        <script>
            function getURLVariable(name) {
                var query = window.location.search.substring(1);
                var vars = query.split("&");
                for (var i = 0; i < vars.length; i++) {
                    var pair = vars[i].split("=");
                    if(pair[0] == name){return pair[1]};
                }
                return(false);
            }           
 
            function saveOptions() {
                var options = {
                    'stopId1': $("#stopId1").val(),
                    'stopId2': $("#stopId2").val(),
                    'route': $("#route").val()
                }
                return options;
            }

            function setBus(el) {
                var locId = $(el).closest('a').data("custom-value");
                if (!$("#stopId1").val()) {
                    $("#stopId1").val(locId);
                } else if (!$("#stopId2").val().length) {
                    $("#stopId2").val(locId); 
                } else {
                    $("#infodiv").append('p').html("All stops set, but here is the id: " + locId);
                }
            }

                      
            $().ready(function() {
                var priorSearch1 = getURLVariable('stopId1');
                var priorSearch2 = getURLVariable('stopId2');
                var priorSearch3 = getURLVariable('route');

                if (priorSearch1) { $("#stopId1").val(priorSearch1); }
                if (priorSearch2) { $("#stopId2").val(priorSearch2); }
                if (priorSearch3) { $("#route").val(priorSearch3); }

                $("#b-cancel").click(function() {
                    console.log("cancel config html");
                    document.location = "pebblejs://close";
                });
                $("#b-submit").click(function() {
                    console.log("submit button html");
                    var location = "pebblejs://close#" + encodeURIComponent(JSON.stringify(saveOptions()));
                    console.log("moving to: " + location);
                    console.log(location);
                    document.location = location;
                });
            });
        </script>
    </body>
</html>
